# Darktable *temperature.c* 模块功能解析

## 模块1：代码整体概述
这段代码实现的是 **Darktable** 软件中的“白平衡”功能模块。其核心目标是在解码 RAW（或其他线性图像）时，通过对原始 **R/G/B（及部分传感器的第四通道）** 像素值施加增益系数，使拍摄时的白色光源在输出图像中呈现中性灰色。  
模块既包含精确的物理/色彩科学计算（光谱 → XYZ → 通道系数），也包含对 GUI 控件的组织、OpenCL 加速路径等，属于 Darktable **基础分级**中的“校正”类、**线性色域/场景参考**阶段的工具。

---

## 模块2：光谱功率分布 (SPD) 计算  
代码中提供了两种光谱模型：  

| 函数 | 物理意义 | 主要公式/常数 | 适用范围 |
|------|----------|---------------|----------|
| `_spd_blackbody` | 普朗克黑体辐射光谱 |  \[ M(λ,T)=\frac{c_1}{λ^5\left(e^{c_2/(λT)}-1\right)} \] 其中 `c1`, `c2` 由普朗克常数 *h*、光速 *c*、玻尔兹曼常数 *k* 计算 | 低色温或需要严格依照 Planckian 光源时 |
| `_spd_daylight`  | CIE **D 系列日光** SPD | 线性组合 \[S_D(λ) = S_0 + M_1 S_1 + M_2 S_2\]，系数 `M`, `M1`, `M2` 由色温推算的 `(x_D,y_D)` 计算 | 4000 K – 25000 K 日光条件 |

---

## 模块3：光谱 → XYZ 三刺激值转换  
函数 `_spectrum_to_XYZ` 采用 **CIE 1931 标准观察者色匹配函数**（表格形式）执行数值积分：  
\[
X=\sum P(λ)\,\bar x(λ)\,Δλ,\;
Y=\sum P(λ)\,\bar y(λ)\,Δλ,\;
Z=\sum P(λ)\,\bar z(λ)\,Δλ
\]  
结果按最大分量归一化，方便后续矩阵变换。

---

## 模块4：色温 / 色调 与 XYZ / 通道系数互转  

| 功能 | 实现要点 |
|------|----------|
| **色温 → XYZ** (`_temperature_to_XYZ`) | <4000 K 用黑体模型；≥4000 K 用日光模型 |
| **色温+Tint → XYZ** (`_temperature_tint_to_XYZ`) | 在 XYZ 上简单对 *Y* 分量除以 *tint*（经验做法） |
| **XYZ → 色温+Tint** (`_XYZ_to_temperature`) | 二分搜索匹配 Z/X 比确定色温，再以 Y/X 比估算 Tint |
| **XYZ → 通道增益** (`_xyz2mul`) | 使用 `XYZ_to_CAM` 矩阵投到相机原始 RGB，再取倒数得到增益，绿通道归一化为 1 |
| **色温+Tint → 增益** (`_temp2mul`) | 组合以上步骤一次完成 |

---

## 模块5：增益应用到像素  
`process()` 函数遍历 ROI 内像素并按滤色器类型（Bayer、X-Trans、已去马赛克）乘以对应增益：  

1. **Bayer**：按 `FC(row,col)` 判定 R/G/B，选用 `d->coeffs[k]`。  
2. **X-Trans**：同理但使用 6×6 Pattern 表。  
3. **非 RAW/RGB**：对 4-float 像素向量整体乘系数。

GPU 端 `process_cl()` 提供相同算法的 OpenCL 实现。

---

## 模块6：GUI 控件  
主要控件与交互：

| 控件 | 作用 |
|------|------|
| 色温/色调滑块 | 人性化参数，实时映射到通道系数 |
| RGB\(Y\) 滑块 | 直接微调通道增益；支持彩色渐变背景 |
| 预设下拉框 | *As-Shot*、*Camera Reference (D65)*、相机厂商预设、用户自定等 |
| 取色器按钮 | 从图像选区取平均色，反算通道增益 |
| 彩色模式切换 | 点击“scene illuminant temp”标题可在「无色 / 光源色 / 效果模拟」三种 slider 配色方案间切换 |

---

## 模块7：工作流中的角色  
- **经典工作流**：白平衡模块负责将 *As-Shot* 或手动色温直接校正到目标白点。  
- **现代/场景参考工作流**：通常将本模块设置为 “D65 参考” 或 “As-Shot → D65 延迟校正”，后续再由 *Color Calibration* 等模块完成完整版 **Chromatic Adaptation (CAT)**。

---

## 小结
该模块通过**物理级光谱建模 → 色度积分 → 相机矩阵变换 → 通道线性增益**的链路，实现了从抽象的“色温 / Tint”到具体“像素缩放系数”的精确映射，既保证了专业准确度，也给予用户直观便捷的交互体验。