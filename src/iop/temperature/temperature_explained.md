# Python *temperature.py*脚本说明
## 目录

1. 简介  
2. 依赖库  
3. 颜色科学基础数据  
   3.1 CIE 1931 2° 色匹配函数  
   3.2 物理常数与黑体辐射常数  
4. 核心函数解析  
   4.1 `spectral_radiance_blackbody`  
   4.2 `compute_XYZ_from_spectrum`  
   4.3 `calculate_wb_coeffs`  
5. 交互入口 `main()`  
6. 程序执行流程图  
7. 精度与性能注意事项  
8. 可扩展方向  
9. 结语  

---

## 1. 简介

本脚本通过输入 **色温 (Kelvin)** 与可选 **Tint** 值，计算数码相机常用的 **RGB 白平衡增益系数**。  
支持两类光源模型：

* 低色温/普通光源 → **Planck 黑体辐射**  
* 4000 K 以上日光 → **CIE 标准 D 系列** 经验模型  

结果可直接用于 RAW 解码或后期处理。

---

## 2. 依赖库

```python
import math
from PIL import Image   # 目前未使用，留作图像处理扩展
```

* **math**：指数、幂运算等基础数学工具  
* **Pillow (PIL)**：潜在地对图像像素应用白平衡增益  

---

## 3. 颜色科学基础数据

### 3.1 CIE 1931 2° 色匹配函数 `cie_xyz_table`

| λ (nm) | x̄ | ȳ | z̄ |
| :---: | :---: | :---: | :---: |
| 380 | 0.0014 | 0.0000 | 0.0065 |
| … | … | … | … |
| 780 | 0.0000 | 0.0000 | 0.0000 |

* 可见光 380–780 nm，每 10 nm 采样  
* 把光谱功率 *P(λ)* 积分到三刺激值 **X/Y/Z**  
* 表格为精简版，仅供演示；工程应用应使用官方 5 nm 或更细步距数据  

### 3.2 物理常数与黑体辐射常数

| 符号 | 数值 | 描述 |
| :-- | :-- | :-- |
| h | 6.626 070 15 ×10⁻³⁴ J·s | 普朗克常数 |
| c | 2.997 924 58 ×10⁸ m/s | 真空光速 |
| k\_B | 1.380 649 ×10⁻²³ J/K | 玻尔兹曼常数 |
| c₁ | 2πhc² | 第一辐射常数 |
| c₂ | hc/k\_B | 第二辐射常数 |

---

## 4. 核心函数解析

### 4.1 `spectral_radiance_blackbody(wavelength_m, T)`

Planck 定律：  

M(λ,T) = c₁ / [ λ⁵ · (exp(c₂/(λT)) − 1) ]

实现细节：  
1. 计算指数项 `c₂/(λT)`，大于 700 时直接返回 0 以防 `exp` 上溢  
2. 返回相对光谱辐射功率（未归一化）  

---

### 4.2 `compute_XYZ_from_spectrum(tempK, use_daylight_model=True)`

1. 若 `tempK ≥ 4000 K` 且允许日光模型：  
   * 用 **CIE D 系列** 多项式求色度坐标 (x\_D, y\_D)  
   * 设 Y = 1，依公式 X = x/y、Z = (1−x−y)/y  
2. 否则：  
   * 对 `cie_xyz_table` 做矩形积分  
   * 每区间中心 λ 估算黑体功率 P(λ)  
   * 累加 ∑ P·x̄, ∑ P·ȳ, ∑ P·z̄  
   * 最终归一化令 Y = 1  

返回示例：D65 → (0.950, 1.000, 1.089)  

---

### 4.3 `calculate_wb_coeffs(tempK, tint=1.0)`

流程：  
1. 调用前述函数得到 XYZ  
2. Tint 调整：Y ← Y / tint  
   * tint > 1：整体偏绿  
   * tint < 1：整体偏品红  
3. 假定 G 通道为基准 1，高度简化的 **伪逆矩阵**：  
   R\_gain = Y/X  B\_gain = Y/Z  G\_gain = 1  
4. 若 X 或 Z 为 0，返回 (1,1,1) 防除零  

> 专业相机会用 3×3 色彩矩阵乘 XYZ 得真实 RGB；此处仅求相对系数。  

---

## 5. 交互入口 `main()`

```python
tempK = float(input("请输入色温："))
tint  = float(input("请输入色调(tint)："))
r,g,b = calculate_wb_coeffs(tempK, tint)
print(f"R={r:.3f}, G={g:.3f}, B={b:.3f}")
```

随后脚本还会对常见色温 (2800–10000 K) 批量演示默认 Tint = 1.0 的结果。

---

## 6. 程序执行流程图

```
用户输入 ─┐
          ▼
 calculate_wb_coeffs
     ├── compute_XYZ_from_spectrum
     │     ├─ 日光模型 (≥4000K)
     │     └─ 黑体积分 (<4000K)
     └── XYZ→RGB 增益 (含 Tint)
          ▼
       控制台输出
```

---

## 7. 精度与性能注意事项

1. 10 nm 采样 & 矩形积分 ≈ ΔE 1–2；生产场景应用 5 nm 甚至 1 nm 步长  
2. 41 段循环运算量极低，可实时计算  
3. 指数保护阈值 700 足以覆盖 ≤25 000 K 场景  
4. 若需批量处理图像，建议引入 **NumPy** 向量化以提升速度  

---

## 8. 可扩展方向

* 完整 CIE 表 / 1964 10° 观察者  
* 双光源（dual-illuminant）白平衡  
* GUI 调色板（Tkinter / PyQt / Web 前端）  
* 将 `PIL.Image` 代码补全：  
  1. 读取线性 RGB / RAW  
  2. 逐像素乘以 (R,G,B) 增益  
  3. Γ 编码 & 色彩空间转换  
  4. 保存/显示  
